{% extends "Base/base.html" %}

{% block content %}
  <div class="container mt-5">
    <h2>Generar informe acumulado de sensibilidad</h2>
    <form id="form-informe" method="post" class="mt-4">
      {% csrf_token %}
      <div class="mb-3">
        {{ form.microorganismo.label_tag }}<br>
        {{ form.microorganismo }}
        {% if form.microorganismo.errors %}
          <div class="text-danger">{{ form.microorganismo.errors }}</div>
        {% endif %}
      </div>

      <div class="mb-3">
        {{ form.fecha_inicial.label_tag }}<br>
        {{ form.fecha_inicial }}
        {% if form.fecha_inicial.errors %}
          <div class="text-danger">{{ form.fecha_inicial.errors }}</div>
        {% endif %}
      </div>
        <div class="mb-3">
        {{ form.fecha_final.label_tag }}<br>
        {{ form.fecha_final }}
        {% if form.fecha_final.errors %}
          <div class="text-danger">{{ form.fecha_final.errors }}</div>
        {% endif %}
      </div>

      <div class="form-check mb-4">
        {{ form.considerar_variantes }}
        {{ form.considerar_variantes.label_tag }}
      </div>

      <div class="form-check mb-4">
        {{ form.unificar_sei_con_sensibles }}
        {{ form.unificar_sei_con_sensibles.label_tag }}
      </div>
        <div class="form-check mb-4">
        {{ form.comparar_con_periodo_anterior }}
        {{ form.comparar_con_periodo_anterior.label_tag }}
      </div>

      <div class="mb-3">
          <label for="{{ form.servicio.id_for_label }}">Servicio:</label>
          {{ form.servicio }}
      </div>

      <div class="mb-3">
          <label for="{{ form.categoria_muestra.id_for_label }}">Tipo de muestra:</label>
          {{ form.categoria_muestra }}
      </div>

      <button type="submit" class="btn btn-primary">Generar informe PDF</button>
    </form>
  </div>
{% endblock %}

{% block extra_footer %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>

// Intercepta el envío del formulario
$('#form-informe').on('submit', function (e) {
    e.preventDefault();

    var $form = $(this);
    var $mensajes = $('.messages-container');

    // Crea el contenedor de mensajes si no existe
    if ($mensajes.length === 0) {
        $mensajes = $('<div class="messages-container"></div>');
        $form.before($mensajes);
    }

    // Limpia errores anteriores
    $form.find('.text-danger').remove();
    $form.find('.is-invalid').removeClass('is-invalid');

    // Mostrar spinner
    $mensajes.html('<div class="alert alert-info"><span class="spinner-border spinner-border-sm me-2"></span>Generando informe...</div>');

    // ÚNICA PETICIÓN usando XMLHttpRequest con responseType blob
    var xhr = new XMLHttpRequest();
    xhr.open('POST', $form.attr('action') || window.location.href, true);
    xhr.responseType = 'blob';
    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest'); // Para que Django detecte AJAX

    xhr.onload = function() {
        var contentType = xhr.getResponseHeader('Content-Type');

        // CASO 1: Respuesta es JSON (errores de validación)
        if (contentType && contentType.includes('application/json')) {
            var reader = new FileReader();
            reader.onload = function() {
                try {
                    var data = JSON.parse(reader.result);
                    if (data.errors) {
                        mostrarErrores(data.errors);
                    }
                } catch (e) {
                    $mensajes.html('<div class="alert alert-error alert-dismissible fade show"><i class="bi bi-shield-x me-2"></i>Error al procesar la respuesta.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button></div>');
                }
            };
            reader.readAsText(xhr.response);
        }
        // CASO 2: Respuesta es PDF (éxito)
        else if (contentType && contentType.includes('application/pdf')) {
            descargarPDF(xhr);
        }
        // CASO 3: Otro tipo de contenido
        else {
            $mensajes.html('<div class="alert alert-error alert-dismissible fade show"><i class="bi bi-shield-x me-2"></i>Respuesta inesperada del servidor.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button></div>');
        }
    };

    xhr.onerror = function() {
        $mensajes.html('<div class="alert alert-error alert-dismissible fade show"><i class="bi bi-shield-x me-2"></i>Error al generar el informe. Inténtalo de nuevo.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button></div>');
    };

    // Enviar formulario
    xhr.send(new FormData($form[0]));

    // Función para mostrar errores de validación
    function mostrarErrores(errors) {
        var mensajes = [];

        $.each(errors, function(field, errorList) {
            if (field === '__all__') {
                $.each(errorList, function(i, err) {
                    mensajes.push(err.message);
                });
            } else {
                var $field = $form.find('[name="' + field + '"]');
                $field.addClass('is-invalid');

                $.each(errorList, function(i, err) {
                    $field.closest('.mb-3, .form-check').append('<div class="text-danger small mt-1">' + err.message + '</div>');
                });
            }
        });

        if (mensajes.length > 0) {
            $mensajes.html('<div class="alert alert-error alert-dismissible fade show"><i class="bi bi-shield-x me-2"></i>' + mensajes.join('<br>') + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button></div>');
        } else {
            $mensajes.html('<div class="alert alert-error alert-dismissible fade show"><i class="bi bi-shield-x me-2"></i>Por favor, corrige los errores en el formulario.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button></div>');
        }
    }

    // Función para descargar el PDF
    function descargarPDF(xhr) {
        // Extraer nombre del archivo
        var filename = 'informe.pdf';
        var disposition = xhr.getResponseHeader('Content-Disposition');
        if (disposition) {
        // ref: https://stackoverflow.com/questions/40939380/how-to-get-file-name-from-content-disposition
            var match = disposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
            if (match && match[1]) filename = match[1].replace(/['"]/g, '');
        }

        // Crear enlace y descargar
        var url = window.URL.createObjectURL(xhr.response);
        var link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();

        // Limpiar recursos
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);

        // Mensaje de éxito
        $mensajes.html('<div class="alert alert-exito alert-dismissible fade show"><i class="bi bi-check-circle me-2"></i>Informe generado con éxito.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button></div>');

        setTimeout(function() { $mensajes.find('.alert').fadeOut(); }, 5000);
    }
});
</script>
{% endblock %}